# This workflow will build a .NET framework project(s)
# For more information see: https://docs.github.com/en/actions/automating-builds-and-tests/building-and-testing-net
# this build runs for every push where a change to src directory is included
name: 'CQ : Build and Test : Permissions API'
on:
  workflow_dispatch:
  

env:
  NET_VERSION: '6.0.x'
  LEGALLEAD_INSTALLATION_KEY: ${{ secrets.LEGALLEAD_INSTALLATION_KEY }}
  SOLUTION_NAME: ${{ github.workspace }}/src/api/legallead.api.sln
  PROJECT_NAME: ${{ github.workspace }}/src/api/permissions.api.tests/permissions.api.tests.csproj

jobs:
  build:

    runs-on: windows-latest

    steps:
    - uses: actions/checkout@v4
    - name: Setup dotnet
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: ${{ env.NET_VERSION }}

    - name: Setup npm
      uses: actions/setup-node@v4
      with:
        node-version: 'latest'

    - name: Install newman
      run: npm install -g newman

    - name: Install dependencies
      run: dotnet restore ${{ env.SOLUTION_NAME }}

    - name: Unit Test with dotnet
      run: dotnet test ${{ env.PROJECT_NAME }} --logger trx --results-directory "TestResults-${{ env.NET_VERSION }}"
      
    - name: Postman Testing
      run: newman run ${{ github.workspace }}/postman/ll-authorizations.postman_collection.json --environment ${{ github.workspace }}/postman/LL-AWS.postman_environment.json

    - name: Upload dotnet test results
      uses: actions/upload-artifact@v4
      if: ${{ always() }}
      with: 
        name: dotnet-results-permissions-api-${{ env.NET_VERSION }}
        path: TestResults-${{ env.NET_VERSION }}